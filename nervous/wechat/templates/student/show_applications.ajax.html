<div class="top-row">
    <a>&nbsp;</a>
    <a class="fake-link pull-right">
        <strong>我的备案申请　<i class="fa fa-briefcase fa-fw"></i></strong>
    </a>
</div>
<hr>
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>我的备案申请<span class="badge pull-right">{{ pending_count }}</span></h4>
            </div>
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="application-list">
                        <thead>
                        <tr>
                            <th>公众号名称</th>
                            <th>公众号简介</th>
                            <th>审批状态</th>
                            <th>处理人</th>
                            <th>
                                <div style="width: 55px"></div>
                            </th>
                            <th>
                                <div style="width: 55px"></div>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for app in applications %}
                            <tr>
                                <td>{{ app.name }}</td>
                                <td>{{ app.description|linebreaksbr|safe }}</td>
                                <td>
                                    <span class="fa {{ app.status_glyphicon }} fa-fw"></span> {{ app.status_name }}
                                </td>
                                <td>{{ app.operator_admin }}</td>
                                <td>
                                    {% if app.status_name == status_name.not_submitted %}
                                        <a data-id="{{ app.id }}" class="fake-link modify-link">
                                            <span class="glyphicon glyphicon-check"></span> 修改
                                        </a>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if app.status_name == status_name.pending %}
                                        <a data-id="{{ app.id }}" class="fake-link recall-link">
                                            <span class="glyphicon glyphicon-check"></span>
                                            撤回
                                        </a>
                                    {% elif app.status_name == status_name.not_submitted %}
                                        <a data-id="{{ app.id }}" class="fake-link delete-link">
                                            <span class="glyphicon glyphicon-check"></span>
                                            删除
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        <script>
                            $(function () {
                                var msg = $("#error-msg");
                                msg.fadeOut(0);
                                msg.find("> button").click(function () {
                                    $("#error-msg").fadeOut();
                                });

                                $(".modify-link").click(function () {
                                    var id = $(this).data("id");
                                    loadContent("/student/modify_application/" + id);
                                });
                                $(".delete-link").click(function (event) {
                                    event.preventDefault();
                                    var id = $(this).data("id");
                                    var url = "/api/delete_application/" + id;
                                    $.ajax({
                                        type: "POST",
                                        url: url,
                                        data: "",
                                        success: function (data) {
                                            if (data.status === "ok") {
                                                alert('删除成功!');
                                                loadContentOfItem("#my-applications-item", {replace: true});
                                            }
                                        },
                                        error: function (xhr, textStatus, errorThrown) {
                                            var msg = $("#error-msg");
                                            msg.find("label").html("提交申请遇到错误：" + textStatus + ": " + errorThrown);
                                            console.log(xhr.responseText);
                                            msg.fadeIn();
                                        }
                                    });
                                });
                                $(".recall-link").click(function (event) {
                                    event.preventDefault();
                                    var id = $(this).data("id");
                                    var url = "/api/recall_application/" + id;
                                    $.ajax({
                                        type: "POST",
                                        url: url,
                                        data: "",
                                        success: function (data) {
                                            if (data.status === "ok") {
                                                alert('撤回成功!');
                                                loadContentOfItem("#my-applications-item", {replace: true});
                                            }
                                        },
                                        error: function (xhr, textStatus, errorThrown) {
                                            var msg = $("#error-msg");
                                            msg.find("label").html("提交申请遇到错误：" + textStatus + ": " + errorThrown);
                                            console.log(xhr.responseText);
                                            msg.fadeIn();
                                        }
                                    });
                                });
                            });
                        </script>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
